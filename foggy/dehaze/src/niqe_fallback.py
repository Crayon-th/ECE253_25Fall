"""Lightweight NIQE implementation used when piq/piqa are unavailable."""

from __future__ import annotations

import math

import cv2
import numpy as np

_NIQE_PATCH_SIZE = 96
_WINDOW = cv2.getGaussianKernel(7, 7.0 / 6.0)
_GAUSSIAN_KERNEL = (_WINDOW @ _WINDOW.T).astype(np.float64)

_NIQE_POP_MU = np.array([
2.906448260073254, 0.991241513121221, 0.867284798534799, 0.033766826252267, 0.191298631419577, 0.240634516564513,
    0.863001373626374, 0.046572841079660, 0.180259155232154, 0.248031505797588, 0.864694597069596, -0.025021713563315,
    0.234614992578728, 0.234614992578728, 0.864347069597070, -0.024411512874525, 0.233939350688437, 0.233939350688437,
    3.093084249084246, 1.005387722474340, 0.887489468864470, 0.027838829996467, 0.205960172578068, 0.246286554017561,
    0.879890567765567, 0.040373479569692, 0.193471625315693, 0.252188871263330, 0.884151556776557, -0.026137033943275,
    0.245385355049834, 0.245385355049834, 0.884286172161172, -0.026540888214662, 0.245748531659118, 0.245748531659118,
], dtype=np.float64)

_NIQE_POP_COV = np.array([
[0.927392192466050, 0.088554658367608, 0.112193933661125, 0.009055741204154, 0.053506288845355, 0.065525320619015, 0.112736377304270, 0.020341366465488, 0.045954270741192, 0.072353091131752, 0.108189146124356, -0.007820361159088, 0.065091642413238, 0.065091642413238, 0.107885224562009, -0.007769246433016, 0.064395754846381, 0.064395754846381, 0.813807026807215, 0.103690681467023, 0.133409566564353, 0.007130675335511, 0.073578129697056, 0.082316332828428, 0.144153961124213, 0.012773722258772, 0.070950718226338, 0.087144282248544, 0.120670986086082, -0.011939056137969, 0.084805903814013, 0.084805903814013, 0.124109883571898, -0.014241858893984, 0.086555902873403, 0.086555902873403],
    [0.088554658367608, 0.029548371571184, 0.018570563338182, 0.001313546999733, 0.014350634551384, 0.016091869265028, 0.018462965138273, 0.002523885869774, 0.013428896698609, 0.016800957048365, 0.017478793816981, -0.002756598131513, 0.016839099521810, 0.016839099521810, 0.017411863349670, -0.002583119558714, 0.016679007834353, 0.016679007834353, 0.055489017444906, 0.023339663484976, 0.014469012622665, 0.000146799274876, 0.012410072965510, 0.012537839412733, 0.014359617978256, 0.000922795593929, 0.011787455721550, 0.012979978831544, 0.013053013633601, -0.002087242248320, 0.013318892078465, 0.013318892078465, 0.013082765337306, -0.002159779645800, 0.013368222290773, 0.013368222290773],
    [0.112193933661125, 0.018570563338182, 0.019137251880582, 0.001021616156058, 0.010823627232429, 0.012166383558786, 0.018033835614111, 0.003891402173182, 0.008446086518710, 0.013637530670103, 0.017220285369044, -0.001610805278257, 0.012095655825962, 0.012095655825962, 0.017188690390614, -0.001457434249006, 0.011952286863376, 0.011952286863376, 0.089535493631274, 0.017733927600143, 0.018611669972683, 0.000262191692548, 0.011684976069270, 0.011923134301110, 0.018707696778218, 0.002675181779457, 0.009792255230708, 0.013341596925962, 0.016058491860598, -0.001809071186526, 0.012392898108419, 0.012392898108419, 0.016404333486448, -0.001812088499367, 0.012412491484723, 0.012412491484723],
    [0.009055741204154, 0.001313546999733, 0.001021616156058, 0.001798931604608, -0.000691182704448, 0.001824643974137, 0.001953877429887, -0.000930131062790, 0.001604249849710, 0.000288688901819, 0.001205482332032, 0.000245149713167, 0.000522575965175, 0.000522575965175, 0.001129331735018, 0.000252624446025, 0.000500094554419, 0.000500094554419, 0.011920154212730, 0.002146209598693, 0.001658636699519, 0.001668023957993, 0.000108102922965, 0.002422933514211, 0.002810597788713, -0.000901996051244, 0.002317937712141, 0.001017866938640, 0.001663296936209, -0.000063161613912, 0.001391991473610, 0.001391991473610, 0.001647752170202, 0.000069464626390, 0.001279747906347, 0.001279747906347],
    [0.053506288845355, 0.014350634551384, 0.010823627232429, -0.000691182704448, 0.008959450400319, 0.007923110812049, 0.009768676060617, 0.002554685724189, 0.006244709396813, 0.009694145804515, 0.009610886442431, -0.001732779752924, 0.009219516887948, 0.009219516887948, 0.009618056911909, -0.001605971135217, 0.009110160447869, 0.009110160447869, 0.029165155778253, 0.010885650810568, 0.008324864671694, -0.001264099171778, 0.007561923997604, 0.005742537655873, 0.007485201169456, 0.001536487701855, 0.005220405113748, 0.007312824757942, 0.007015227494376, -0.001199749404150, 0.006952859680136, 0.006952859680136, 0.007104941527031, -0.001333474188653, 0.007053598791479, 0.007053598791479],
    [0.065525320619015, 0.016091869265028, 0.012166383558786, 0.001824643974137, 0.007923110812049, 0.010413327366887, 0.012437759128646, 0.001237999756206, 0.008445710207884, 0.010029116550921, 0.011233380272229, -0.001385530833296, 0.009887391984855, 0.009887391984855, 0.011137711471388, -0.001253781719392, 0.009751401821200, 0.009751401821200, 0.045087460517061, 0.013792129574712, 0.010482760526651, 0.001071971832354, 0.007611445835442, 0.009041738939252, 0.011263223842957, 0.000248144376692, 0.008397688016314, 0.008634001930387, 0.009224313442707, -0.001276672449139, 0.008806760805024, 0.008806760805024, 0.009279007707074, -0.001237971515291, 0.008758241358753, 0.008758241358753],
    [0.112736377304270, 0.018462965138273, 0.018033835614111, 0.001953877429887, 0.009768676060617, 0.012437759128646, 0.018792551990783, 0.002891320674313, 0.009410675643811, 0.013181178320173, 0.016872415444896, -0.001409769203869, 0.011837617252926, 0.011837617252926, 0.016833150233070, -0.001391424806173, 0.011763568124664, 0.011763568124664, 0.093061340699612, 0.017970214089847, 0.018177341975077, 0.001539060112704, 0.010770761766407, 0.012798945655579, 0.019575990072513, 0.001361815906616, 0.011253486773586, 0.012962162118453, 0.016038466580545, -0.001652494421969, 0.012470523919335, 0.012470523919335, 0.016318982657574, -0.001829219192436, 0.012597165260661, 0.012597165260661],
    [0.020341366465488, 0.002523885869774, 0.003891402173182, -0.000930131062790, 0.002554685724189, 0.001237999756206, 0.002891320674313, 0.002192578610108, -0.000026569878375, 0.002996579574521, 0.003333820294728, -0.000220284337483, 0.001856093081176, 0.001856093081176, 0.003416067619407, -0.000288932566407, 0.001929321982527, 0.001929321982527, 0.013211524426311, 0.002737598808952, 0.003607327345244, -0.001148761056188, 0.002800039125240, 0.001180528082484, 0.002602670812893, 0.001825426096399, 0.000341303499614, 0.002866715384553, 0.002935711898628, -0.000347728645444, 0.002027962225033, 0.002027962225033, 0.003120450399042, -0.000484751480361, 0.002156484361113, 0.002156484361113],
    [0.045954270741192, 0.013428896698609, 0.008446086518710, 0.001604249849710, 0.006244709396813, 0.008445710207884, 0.009410675643811, -0.000026569878375, 0.007784887780828, 0.007624863261421, 0.008039335001579, -0.001362309874958, 0.008207579673766, 0.008207579673766, 0.007927148348084, -0.001207083646329, 0.008042753933408, 0.008042753933408, 0.029603078059974, 0.010507465771439, 0.006862487731374, 0.001178184157752, 0.005311542379280, 0.006914525975941, 0.007934351484264, -0.000820730720157, 0.007101217161880, 0.005876255150786, 0.006183747623981, -0.000982164687501, 0.006546199491273, 0.006546199491273, 0.006095371639117, -0.000939154034190, 0.006478544369432, 0.006478544369432],
    [0.072353091131752, 0.016800957048365, 0.013637530670103, 0.000288688901819, 0.009694145804515, 0.010029116550921, 0.013181178320173, 0.002996579574521, 0.007624863261421, 0.011647759611456, 0.012466827815656, -0.001646489417021, 0.010653763894854, 0.010653763894854, 0.012463988775540, -0.001572963699987, 0.010580475026882, 0.010580475026882, 0.046751818891546, 0.014196919814005, 0.011652723898986, -0.000434709384811, 0.009099779270804, 0.008425776769879, 0.011281720473441, 0.001716494903169, 0.007433170702176, 0.009729042343777, 0.010058872464066, -0.001443131368951, 0.009230529993272, 0.009230529993272, 0.010216284971536, -0.001573258251816, 0.009328869731918, 0.009328869731918],
    [0.108189146124356, 0.017478793816981, 0.017220285369044, 0.001205482332032, 0.009610886442431, 0.011233380272229, 0.016872415444896, 0.003333820294728, 0.008039335001579, 0.012466827815656, 0.017619478376658, -0.002025754031767, 0.012069690452472, 0.012069690452472, 0.017161152769318, -0.001538882629204, 0.011528635343626, 0.011528635343626, 0.092415120565341, 0.016826402675262, 0.017451611761673, 0.000652205981134, 0.010612876329957, 0.011409766953545, 0.017363880901832, 0.002177784970025, 0.009416474436444, 0.012292483301484, 0.016728941863660, -0.002433960237861, 0.012634725033463, 0.012634725033463, 0.016548406723239, -0.001977439875772, 0.012149418588547, 0.012149418588547],
    [-0.007820361159088, -0.002756598131513, -0.001610805278257, 0.000245149713167, -0.001732779752924, -0.001385530833296, -0.001409769203869, -0.000220284337483, -0.001362309874958, -0.001646489417021, -0.002025754031767, 0.001227552005836, -0.002557695677794, -0.002557695677794, -0.001690746856995, 0.000103956845707, -0.001629743256426, -0.001629743256426, -0.003899061202418, -0.001448451175940, -0.001008930574168, 0.000272470559065, -0.001066413373193, -0.000679197947928, -0.000570873953288, -0.000043690218083, -0.000753094311758, -0.000807986197076, -0.001410663691646, 0.000993703704121, -0.001676820148267, -0.001676820148267, -0.001005874515003, -0.000072230902592, -0.000770441300992, -0.000770441300992],
    [0.065091642413238, 0.016839099521810, 0.012095655825962, 0.000522575965175, 0.009219516887948, 0.009887391984855, 0.011837617252926, 0.001856093081176, 0.008207579673766, 0.010653763894854, 0.012069690452472, -0.002557695677794, 0.011381130972261, 0.011381130972261, 0.011635451907060, -0.001499953008805, 0.010441776744374, 0.010441776744374, 0.042389905171369, 0.013217059524451, 0.010040762110313, -0.000095837350644, 0.008079242822772, 0.007879584324376, 0.009689071467918, 0.000769311160917, 0.007361708849774, 0.008350144910174, 0.009561759635960, -0.002145638826458, 0.009284416618531, 0.009284416618531, 0.009196017583394, -0.001262923571853, 0.008483342275716, 0.008483342275716],
    [0.065091642413238, 0.016839099521810, 0.012095655825962, 0.000522575965175, 0.009219516887948, 0.009887391984855, 0.011837617252926, 0.001856093081176, 0.008207579673766, 0.010653763894854, 0.012069690452472, -0.002557695677794, 0.011381130972261, 0.011381130972261, 0.011635451907060, -0.001499953008805, 0.010441776744374, 0.010441776744374, 0.042389905171369, 0.013217059524451, 0.010040762110313, -0.000095837350644, 0.008079242822772, 0.007879584324376, 0.009689071467918, 0.000769311160917, 0.007361708849774, 0.008350144910174, 0.009561759635960, -0.002145638826458, 0.009284416618531, 0.009284416618531, 0.009196017583394, -0.001262923571853, 0.008483342275716, 0.008483342275716],
    [0.107885224562009, 0.017411863349670, 0.017188690390614, 0.001129331735018, 0.009618056911909, 0.011137711471388, 0.016833150233070, 0.003416067619407, 0.007927148348084, 0.012463988775540, 0.017161152769318, -0.001690746856995, 0.011635451907060, 0.011635451907060, 0.017629407659755, -0.001862769921340, 0.011885391975599, 0.011885391975599, 0.091369951048646, 0.016742236577600, 0.017261786524325, 0.000583942395705, 0.010573822083292, 0.011278776245960, 0.017179026087785, 0.002245151858732, 0.009270354531378, 0.012239787301512, 0.016187252459901, -0.001970216149794, 0.012071745173449, 0.012071745173449, 0.016703322071233, -0.002419096113229, 0.012506914604819, 0.012506914604819],
    [-0.007769246433016, -0.002583119558714, -0.001457434249006, 0.000252624446025, -0.001605971135217, -0.001253781719392, -0.001391424806173, -0.000288932566407, -0.001207083646329, -0.001572963699987, -0.001538882629204, 0.000103956845707, -0.001499953008805, -0.001499953008805, -0.001862769921340, 0.001077850868770, -0.002305253733703, -0.002305253733703, -0.002765354117385, -0.001391546531871, -0.000909209349958, 0.000328016164782, -0.001038384817551, -0.000588185077962, -0.000623189859399, -0.000070770032087, -0.000688548705487, -0.000778652404131, -0.000902531997365, -0.000143852667011, -0.000646437517218, -0.000646437517218, -0.001128091309768, 0.000891032611120, -0.001480009686781, -0.001480009686781],
    [0.064395754846381, 0.016679007834353, 0.011952286863376, 0.000500094554419, 0.009110160447869, 0.009751401821200, 0.011763568124664, 0.001929321982527, 0.008042753933408, 0.010580475026882, 0.011528635343626, -0.001629743256426, 0.010441776744374, 0.010441776744374, 0.011885391975599, -0.002305253733703, 0.011038109372792, 0.011038109372792, 0.040880762230829, 0.013135681706394, 0.009890571368244, -0.000154793308740, 0.008023748702859, 0.007753107438786, 0.009625369514201, 0.000825736276496, 0.007229828545157, 0.008293514911390, 0.008994110538870, -0.001180257906166, 0.008336075091207, 0.008336075091207, 0.009306753391053, -0.002085508822521, 0.009078131660127, 0.009078131660127],
    [0.064395754846381, 0.016679007834353, 0.011952286863376, 0.000500094554419, 0.009110160447869, 0.009751401821200, 0.011763568124664, 0.001929321982527, 0.008042753933408, 0.010580475026882, 0.011528635343626, -0.001629743256426, 0.010441776744374, 0.010441776744374, 0.011885391975599, -0.002305253733703, 0.011038109372792, 0.011038109372792, 0.040880762230829, 0.013135681706394, 0.009890571368244, -0.000154793308740, 0.008023748702859, 0.007753107438786, 0.009625369514201, 0.000825736276496, 0.007229828545157, 0.008293514911390, 0.008994110538870, -0.001180257906166, 0.008336075091207, 0.008336075091207, 0.009306753391053, -0.002085508822521, 0.009078131660127, 0.009078131660127],
    [0.813807026807215, 0.055489017444906, 0.089535493631274, 0.011920154212730, 0.029165155778253, 0.045087460517061, 0.093061340699612, 0.013211524426311, 0.029603078059974, 0.046751818891546, 0.092415120565341, -0.003899061202418, 0.042389905171369, 0.042389905171369, 0.091369951048646, -0.002765354117385, 0.040880762230829, 0.040880762230829, 1.489128590241946, 0.117478961712613, 0.185589672898640, 0.019242715889258, 0.082737402173653, 0.107559475393360, 0.196168420126217, 0.014940081868995, 0.086708973980970, 0.105544123505879, 0.174849357816562, -0.014442814552660, 0.105458162544652, 0.105458162544652, 0.175831235155438, -0.013333939189519, 0.104306568052935, 0.104306568052935],
    [0.103690681467023, 0.023339663484976, 0.017733927600143, 0.002146209598693, 0.010885650810568, 0.013792129574712, 0.017970214089847, 0.002737598808952, 0.010507465771439, 0.014196919814005, 0.016826402675262, -0.001448451175940, 0.013217059524451, 0.013217059524451, 0.016742236577600, -0.001391546531871, 0.013135681706394, 0.013135681706394, 0.117478961712613, 0.026821845978549, 0.021542786008082, 0.001589649163013, 0.014371556171538, 0.016449542019175, 0.022159585401644, 0.001878407239013, 0.014204926880134, 0.016672082952544, 0.019827017544782, -0.002105954877717, 0.016446567356403, 0.016446567356403, 0.020008808259090, -0.002203241595134, 0.016534025805007, 0.016534025805007],
    [0.133409566564353, 0.014469012622665, 0.018611669972683, 0.001658636699519, 0.008324864671694, 0.010482760526651, 0.018177341975077, 0.003607327345244, 0.006862487731374, 0.011652723898986, 0.017451611761673, -0.001008930574168, 0.010040762110313, 0.010040762110313, 0.017261786524325, -0.000909209349958, 0.009890571368244, 0.009890571368244, 0.185589672898640, 0.021542786008082, 0.034996379183593, 0.002029534565510, 0.016160744109825, 0.018658791505484, 0.034263485562555, 0.004346052443347, 0.013890518355826, 0.019512290422504, 0.029765867148789, -0.002055925398418, 0.017951414748484, 0.017951414748484, 0.030875448961044, -0.001819535880983, 0.017803344596319, 0.017803344596319],
    [0.007130675335511, 0.000146799274876, 0.000262191692548, 0.001668023957993, -0.001264099171778, 0.001071971832354, 0.001539060112704, -0.001148761056188, 0.001178184157752, -0.000434709384811, 0.000652205981134, 0.000272470559065, -0.000095837350644, -0.000095837350644, 0.000583942395705, 0.000328016164782, -0.000154793308740, -0.000154793308740, 0.019242715889258, 0.001589649163013, 0.002029534565510, 0.002579259461865, -0.000728523383235, 0.002816778347652, 0.003698740455061, -0.001280571802264, 0.002553181591841, 0.000739797159742, 0.002190397323945, 0.000180114554655, 0.001145527520079, 0.001145527520079, 0.002047597635515, 0.000357781849097, 0.000963286764771, 0.000963286764771],
    [0.073578129697056, 0.012410072965510, 0.011684976069270, 0.000108102922965, 0.007561923997604, 0.007611445835442, 0.010770761766407, 0.002800039125240, 0.005311542379280, 0.009099779270804, 0.010612876329957, -0.001066413373193, 0.008079242822772, 0.008079242822772, 0.010573822083292, -0.001038384817551, 0.008023748702859, 0.008023748702859, 0.082737402173653, 0.014371556171538, 0.016160744109825, -0.000728523383235, 0.010835365251432, 0.009684079369368, 0.015127772756581, 0.002595021835875, 0.007889791612435, 0.011354967556798, 0.013675806231600, -0.001577962321758, 0.010637812723686, 0.010637812723686, 0.014096163583814, -0.001712795190499, 0.010777260025331, 0.010777260025331],
    [0.082316332828428, 0.012537839412733, 0.011923134301110, 0.002422933514211, 0.005742537655873, 0.009041738939252, 0.012798945655579, 0.001180528082484, 0.006914525975941, 0.008425776769879, 0.011409766953545, -0.000679197947928, 0.007879584324376, 0.007879584324376, 0.011278776245960, -0.000588185077962, 0.007753107438786, 0.007753107438786, 0.107559475393360, 0.016449542019175, 0.018658791505484, 0.002816778347652, 0.009684079369368, 0.013422783600287, 0.019943177122018, 0.000793923755201, 0.011311920925693, 0.012225461641944, 0.016473423771875, -0.001310406858486, 0.012071027045696, 0.012071027045696, 0.016685856605297, -0.001220499778498, 0.011973497620210, 0.011973497620210],
    [0.144153961124213, 0.014359617978256, 0.018707696778218, 0.002810597788713, 0.007485201169456, 0.011263223842957, 0.019575990072513, 0.002602670812893, 0.007934351484264, 0.011281720473441, 0.017363880901832, -0.000570873953288, 0.009689071467918, 0.009689071467918, 0.017179026087785, -0.000623189859399, 0.009625369514201, 0.009625369514201, 0.196168420126217, 0.022159585401644, 0.034263485562555, 0.003698740455061, 0.015127772756581, 0.019943177122018, 0.039366731491386, 0.002770069540765, 0.016779354133432, 0.020146849880508, 0.030195543848864, -0.001636863504437, 0.018321574665191, 0.018321574665191, 0.031502384514497, -0.001647293105988, 0.018386242373063, 0.018386242373063],
    [0.012773722258772, 0.000922795593929, 0.002675181779457, -0.000901996051244, 0.001536487701855, 0.000248144376692, 0.001361815906616, 0.001825426096399, -0.000820730720157, 0.001716494903169, 0.002177784970025, -0.000043690218083, 0.000769311160917, 0.000769311160917, 0.002245151858732, -0.000070770032087, 0.000825736276496, 0.000825736276496, 0.014940081868995, 0.001878407239013, 0.004346052443347, -0.001280571802264, 0.002595021835875, 0.000793923755201, 0.002770069540765, 0.002654950485166, -0.000732591890041, 0.002908451168488, 0.003459260795433, -0.000247920375878, 0.001621776512801, 0.001621776512801, 0.003723555768779, -0.000114207482110, 0.001576947300174, 0.001576947300174],
    [0.070950718226338, 0.011787455721550, 0.009792255230708, 0.002317937712141, 0.005220405113748, 0.008397688016314, 0.011253486773586, 0.000341303499614, 0.007101217161880, 0.007433170702176, 0.009416474436444, -0.000753094311758, 0.007361708849774, 0.007361708849774, 0.009270354531378, -0.000688548705487, 0.007229828545157, 0.007229828545157, 0.086708973980970, 0.014204926880134, 0.013890518355826, 0.002553181591841, 0.007889791612435, 0.011311920925693, 0.016779354133432, -0.000732591890041, 0.011038916877513, 0.009855145119866, 0.012684926141063, -0.001204675254419, 0.010297446448783, 0.010297446448783, 0.012808759908477, -0.001326176362000, 0.010348654176949, 0.010348654176949],
    [0.087144282248544, 0.012979978831544, 0.013341596925962, 0.001017866938640, 0.007312824757942, 0.008634001930387, 0.012962162118453, 0.002866715384553, 0.005876255150786, 0.009729042343777, 0.012292483301484, -0.000807986197076, 0.008350144910174, 0.008350144910174, 0.012239787301512, -0.000778652404131, 0.008293514911390, 0.008293514911390, 0.105544123505879, 0.016672082952544, 0.019512290422504, 0.000739797159742, 0.011354967556798, 0.012225461641944, 0.020146849880508, 0.002908451168488, 0.009855145119866, 0.013685322917481, 0.017130092404401, -0.001523330464227, 0.012365152188185, 0.012365152188185, 0.017582496543289, -0.001484355741853, 0.012368278481901, 0.012368278481901],
    [0.120670986086082, 0.013053013633601, 0.016058491860598, 0.001663296936209, 0.007015227494376, 0.009224313442707, 0.016038466580545, 0.002935711898628, 0.006183747623981, 0.010058872464066, 0.016728941863660, -0.001410663691646, 0.009561759635960, 0.009561759635960, 0.016187252459901, -0.000902531997365, 0.008994110538870, 0.008994110538870, 0.174849357816562, 0.019827017544782, 0.029765867148789, 0.002190397323945, 0.013675806231600, 0.016473423771875, 0.030195543848864, 0.003459260795433, 0.012684926141063, 0.017130092404401, 0.029109398458409, -0.002742316360989, 0.017500286516002, 0.017500286516002, 0.028615830177286, -0.001821100096455, 0.016363310006410, 0.016363310006410],
    [-0.011939056137969, -0.002087242248320, -0.001809071186526, -0.000063161613912, -0.001199749404150, -0.001276672449139, -0.001652494421969, -0.000347728645444, -0.000982164687501, -0.001443131368951, -0.002433960237861, 0.000993703704121, -0.002145638826458, -0.002145638826458, -0.001970216149794, -0.000143852667011, -0.001180257906166, -0.001180257906166, -0.014442814552660, -0.002105954877717, -0.002055925398418, 0.000180114554655, -0.001577962321758, -0.001310406858486, -0.001636863504437, -0.000247920375878, -0.001204675254419, -0.001523330464227, -0.002742316360989, 0.001674740315846, -0.002838474535953, -0.002838474535953, -0.002120384768265, -0.000026378241201, -0.001409757753652, -0.001409757753652],
    [0.084805903814013, 0.013318892078465, 0.012392898108419, 0.001391991473610, 0.006952859680136, 0.008806760805024, 0.012470523919335, 0.002027962225033, 0.006546199491273, 0.009230529993272, 0.012634725033463, -0.001676820148267, 0.009284416618531, 0.009284416618531, 0.012071745173449, -0.000646437517218, 0.008336075091207, 0.008336075091207, 0.105458162544652, 0.016446567356403, 0.017951414748484, 0.001145527520079, 0.010637812723686, 0.012071027045696, 0.018321574665191, 0.001621776512801, 0.010297446448783, 0.012365152188185, 0.017500286516002, -0.002838474535953, 0.013483877865118, 0.013483877865118, 0.016897389283524, -0.001389524766395, 0.012102259534337, 0.012102259534337],
    [0.084805903814013, 0.013318892078465, 0.012392898108419, 0.001391991473610, 0.006952859680136, 0.008806760805024, 0.012470523919335, 0.002027962225033, 0.006546199491273, 0.009230529993272, 0.012634725033463, -0.001676820148267, 0.009284416618531, 0.009284416618531, 0.012071745173449, -0.000646437517218, 0.008336075091207, 0.008336075091207, 0.105458162544652, 0.016446567356403, 0.017951414748484, 0.001145527520079, 0.010637812723686, 0.012071027045696, 0.018321574665191, 0.001621776512801, 0.010297446448783, 0.012365152188185, 0.017500286516002, -0.002838474535953, 0.013483877865118, 0.013483877865118, 0.016897389283524, -0.001389524766395, 0.012102259534337, 0.012102259534337],
    [0.124109883571898, 0.013082765337306, 0.016404333486448, 0.001647752170202, 0.007104941527031, 0.009279007707074, 0.016318982657574, 0.003120450399042, 0.006095371639117, 0.010216284971536, 0.016548406723239, -0.001005874515003, 0.009196017583394, 0.009196017583394, 0.016703322071233, -0.001128091309768, 0.009306753391053, 0.009306753391053, 0.175831235155438, 0.020008808259090, 0.030875448961044, 0.002047597635515, 0.014096163583814, 0.016685856605297, 0.031502384514497, 0.003723555768779, 0.012808759908477, 0.017582496543289, 0.028615830177286, -0.002120384768265, 0.016897389283524, 0.016897389283524, 0.030954723839853, -0.002416365480855, 0.017560248342669, 0.017560248342669],
    [-0.014241858893984, -0.002159779645800, -0.001812088499367, 0.000069464626390, -0.001333474188653, -0.001237971515291, -0.001829219192436, -0.000484751480361, -0.000939154034190, -0.001573258251816, -0.001977439875772, -0.000072230902592, -0.001262923571853, -0.001262923571853, -0.002419096113229, 0.000891032611120, -0.002085508822521, -0.002085508822521, -0.013333939189519, -0.002203241595134, -0.001819535880983, 0.000357781849097, -0.001712795190499, -0.001220499778498, -0.001647293105988, -0.000114207482110, -0.001326176362000, -0.001484355741853, -0.001821100096455, -0.000026378241201, -0.001389524766395, -0.001389524766395, -0.002416365480855, 0.001595786484069, -0.002758168312051, -0.002758168312051],
    [0.086555902873403, 0.013368222290773, 0.012412491484723, 0.001279747906347, 0.007053598791479, 0.008758241358753, 0.012597165260661, 0.002156484361113, 0.006478544369432, 0.009328869731918, 0.012149418588547, -0.000770441300992, 0.008483342275716, 0.008483342275716, 0.012506914604819, -0.001480009686781, 0.009078131660127, 0.009078131660127, 0.104306568052935, 0.016534025805007, 0.017803344596319, 0.000963286764771, 0.010777260025331, 0.011973497620210, 0.018386242373063, 0.001576947300174, 0.010348654176949, 0.012368278481901, 0.016363310006410, -0.001409757753652, 0.012102259534337, 0.012102259534337, 0.017560248342669, -0.002758168312051, 0.013393376035160, 0.013393376035160],
    [0.086555902873403, 0.013368222290773, 0.012412491484723, 0.001279747906347, 0.007053598791479, 0.008758241358753, 0.012597165260661, 0.002156484361113, 0.006478544369432, 0.009328869731918, 0.012149418588547, -0.000770441300992, 0.008483342275716, 0.008483342275716, 0.012506914604819, -0.001480009686781, 0.009078131660127, 0.009078131660127, 0.104306568052935, 0.016534025805007, 0.017803344596319, 0.000963286764771, 0.010777260025331, 0.011973497620210, 0.018386242373063, 0.001576947300174, 0.010348654176949, 0.012368278481901, 0.016363310006410, -0.001409757753652, 0.012102259534337, 0.012102259534337, 0.017560248342669, -0.002758168312051, 0.013393376035160, 0.013393376035160],
], dtype=np.float64)

_GAMMA_RANGE = np.arange(0.2, 10.0, 0.001, dtype=np.float64)

def _precompute_prec_gammas() -> np.ndarray:
    values = []
    for gamma_shape in _GAMMA_RANGE:
        a = math.gamma(2.0 / gamma_shape)
        b = math.gamma(1.0 / gamma_shape)
        c = math.gamma(3.0 / gamma_shape)
        values.append((a * a) / (b * c))
    return np.array(values, dtype=np.float64)

_PREC_GAMMAS = _precompute_prec_gammas()


def _aggd_features(data: np.ndarray) -> tuple[float, float, float, float, float, float]:
    flat = data.reshape(-1)
    left = flat[flat < 0]
    right = flat[flat >= 0]
    left_std = float(np.sqrt(np.mean(left * left))) if left.size else 0.0
    right_std = float(np.sqrt(np.mean(right * right))) if right.size else 0.0
    if right_std == 0:
        gamma_hat = np.inf
    else:
        gamma_hat = left_std / (right_std + 1e-12)

    denom = np.mean(flat * flat)
    if denom == 0:
        r_hat = np.inf
    else:
        r_hat = (np.mean(np.abs(flat)) ** 2) / (denom + 1e-12)
    r_hat_norm = r_hat * (((gamma_hat ** 3 + 1) * (gamma_hat + 1)) / ((gamma_hat ** 2 + 1) ** 2))
    pos = int(np.argmin(( _PREC_GAMMAS - r_hat_norm) ** 2))
    alpha = float(_GAMMA_RANGE[pos])
    gam1 = math.gamma(1.0 / alpha)
    gam2 = math.gamma(2.0 / alpha)
    gam3 = math.gamma(3.0 / alpha)
    aggdratio = math.sqrt(gam1) / math.sqrt(gam3)
    bl = aggdratio * left_std
    br = aggdratio * right_std
    mean_param = (br - bl) * (gam2 / gam1)
    return alpha, mean_param, bl, br, left_std, right_std


def _paired_product(img: np.ndarray) -> tuple[np.ndarray, np.ndarray, np.ndarray, np.ndarray]:
    shift1 = np.roll(img, 1, axis=1)
    shift2 = np.roll(img, 1, axis=0)
    shift3 = np.roll(shift2, 1, axis=1)
    shift4 = np.roll(shift2, -1, axis=1)
    h = shift1 * img
    v = shift2 * img
    d1 = shift3 * img
    d2 = shift4 * img
    return h, v, d1, d2


def _niqe_extract_subband_feats(mscn: np.ndarray) -> np.ndarray:
    alpha_m, mean_m, bl, br, lsq, rsq = _aggd_features(mscn.copy())
    pps1, pps2, pps3, pps4 = _paired_product(mscn)
    alpha1, n1, bl1, br1, lsq1, rsq1 = _aggd_features(pps1)
    alpha2, n2, bl2, br2, lsq2, rsq2 = _aggd_features(pps2)
    alpha3, n3, bl3, br3, lsq3, rsq3 = _aggd_features(pps3)
    alpha4, n4, bl4, br4, lsq4, rsq4 = _aggd_features(pps4)
    return np.array([
        alpha_m,
        (bl + br) / 2.0,
        alpha1,
        n1,
        bl1,
        br1,
        alpha2,
        n2,
        bl2,
        br2,
        alpha3,
        n3,
        bl3,
        br3,
        alpha4,
        n4,
        bl4,
        br4,
    ], dtype=np.float64)


def _compute_mscn(image: np.ndarray) -> np.ndarray:
    mu = cv2.filter2D(image, -1, _GAUSSIAN_KERNEL, borderType=cv2.BORDER_REFLECT)
    sigma = cv2.filter2D(image * image, -1, _GAUSSIAN_KERNEL, borderType=cv2.BORDER_REFLECT)
    sigma = np.sqrt(np.maximum(sigma - mu * mu, 0.0))
    return (image - mu) / (sigma + 1.0)


def _crop_to_multiple(image: np.ndarray, patch: int) -> np.ndarray:
    h, w = image.shape
    h -= h % patch
    w -= w % patch
    return image[:h, :w]


def _extract_on_patches(mscn: np.ndarray, patch: int) -> np.ndarray:
    cropped = _crop_to_multiple(mscn, patch)
    h, w = cropped.shape
    if h < patch or w < patch:
        return np.empty((0, 18), dtype=np.float64)
    patches = []
    for y in range(0, h - patch + 1, patch):
        for x in range(0, w - patch + 1, patch):
            patches.append(_niqe_extract_subband_feats(cropped[y : y + patch, x : x + patch]))
    return np.asarray(patches, dtype=np.float64)


def _extract_niqe_features(image: np.ndarray) -> np.ndarray:
    base = _crop_to_multiple(image, _NIQE_PATCH_SIZE)
    down = cv2.resize(base, (max(1, base.shape[1] // 2), max(1, base.shape[0] // 2)), interpolation=cv2.INTER_CUBIC)
    mscn1 = _compute_mscn(base)
    mscn2 = _compute_mscn(down)
    feats_lvl1 = _extract_on_patches(mscn1, _NIQE_PATCH_SIZE)
    feats_lvl2 = _extract_on_patches(mscn2, _NIQE_PATCH_SIZE // 2)
    if feats_lvl1.size == 0 or feats_lvl2.size == 0:
        return np.empty((0, 36), dtype=np.float64)
    return np.hstack((feats_lvl1, feats_lvl2))


def compute_niqe_score(gray_image: np.ndarray) -> float:
    image = np.asarray(gray_image, dtype=np.float32)
    if image.ndim != 2:
        raise ValueError("NIQE fallback expects a grayscale image")
    h, w = image.shape
    if h <= _NIQE_PATCH_SIZE * 2 or w <= _NIQE_PATCH_SIZE * 2:
        raise ValueError("Image is too small for NIQE evaluation")
    feats = _extract_niqe_features(image)
    if feats.shape[0] < 2:
        raise ValueError("Not enough patches for NIQE evaluation")
    sample_mu = np.mean(feats, axis=0)
    sample_cov = np.cov(feats, rowvar=False)
    diff = sample_mu - _NIQE_POP_MU
    cov = (_NIQE_POP_COV + sample_cov) / 2.0
    cov += np.eye(cov.shape[0], dtype=np.float64) * 1e-12
    pinv = np.linalg.pinv(cov)
    distance = float(diff @ pinv @ diff)
    distance = max(distance, 0.0)
    score = float(math.sqrt(distance))
    return score


__all__ = ["compute_niqe_score"]
